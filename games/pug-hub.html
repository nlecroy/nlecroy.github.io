<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pug Hub - Multiplayer Paradise</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #1a1a2e;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameCanvas {
            border: 5px solid #fff;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            image-rendering: crisp-edges;
        }

        /* Chat Box */
        .chat-box {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            height: 400px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            border-radius: 15px 15px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.9rem;
        }

        .chat-message {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 8px;
            background: #f0f0f0;
        }

        .chat-message .username {
            font-weight: bold;
            color: #667eea;
        }

        .chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
        }

        .chat-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .chat-send {
            margin-left: 8px;
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .chat-send:hover {
            background: #764ba2;
        }

        /* UI Overlay */
        .ui-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .ui-overlay h3 {
            margin: 0 0 10px 0;
            color: #667eea;
        }

        .stat {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 1.1rem;
        }

        .stat-label {
            font-weight: bold;
            margin-right: 10px;
        }

        /* Controls Info */
        .controls-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .controls-info h4 {
            margin: 0 0 10px 0;
            color: #667eea;
        }

        .controls-info p {
            margin: 3px 0;
            font-size: 0.9rem;
        }

        /* Skin Shop */
        .skin-shop {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.4);
            z-index: 200;
            display: none;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .skin-shop.active {
            display: block;
        }

        .skin-shop h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .skin-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .skin-item {
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skin-item:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .skin-item.owned {
            border-color: #4ecdc4;
            background: #e8f9f7;
        }

        .skin-item.equipped {
            border-color: #f093fb;
            background: #fce8ff;
        }

        .skin-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
        }

        .skin-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .skin-price {
            color: #667eea;
            font-size: 1.1rem;
        }

        .close-shop {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Username Input */
        .username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .username-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .username-box h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .username-box input {
            width: 250px;
            padding: 12px;
            border: 3px solid #667eea;
            border-radius: 25px;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 20px;
        }

        .username-box button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
        }

        .username-box button:hover {
            transform: scale(1.1);
        }

        .online-count {
            color: #4ecdc4;
            font-size: 0.9rem;
        }

        /* Minigame Modal */
        .minigame-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 500;
        }

        .minigame-modal.active {
            display: flex;
        }

        .minigame-container {
            background: white;
            padding: 20px;
            border-radius: 20px;
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }

        .minigame-container h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        #minigameCanvas {
            border: 3px solid #667eea;
            border-radius: 10px;
        }

        .close-minigame {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .minigame-info {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- UI Overlay -->
        <div class="ui-overlay">
            <h3>üê∂ Player Stats</h3>
            <div class="stat">
                <span class="stat-label">Username:</span>
                <span id="playerName">Loading...</span>
            </div>
            <div class="stat">
                <span class="stat-label">üí∞ Skittles:</span>
                <span id="skittlesCount">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">üë• Online:</span>
                <span id="onlineCount" class="online-count">0</span>
            </div>
            <button onclick="openShop()" style="margin-top: 10px; padding: 8px 15px; background: #f093fb; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">üé® Skin Shop</button>
        </div>

        <!-- Controls Info -->
        <div class="controls-info">
            <h4>üéÆ Controls</h4>
            <p>‚¨ÖÔ∏è‚û°Ô∏è A/D or Arrows - Move</p>
            <p>‚¨ÜÔ∏è W/Space - Jump</p>
            <p>üö™ E - Enter Building</p>
            <p>üí¨ Enter - Chat</p>
        </div>

        <!-- Chat Box -->
        <div class="chat-box">
            <div class="chat-header">
                üí¨ Pug Hub Chat
                <span class="online-count" id="chatOnlineCount">0 online</span>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." maxlength="200">
                <button class="chat-send" onclick="sendChatMessage()">Send</button>
            </div>
        </div>

        <!-- Skin Shop -->
        <div class="skin-shop" id="skinShop">
            <button class="close-shop" onclick="closeShop()">√ó</button>
            <h2>üé® Pug Skin Shop</h2>
            <div class="stat" style="margin-bottom: 20px;">
                <span class="stat-label">Your Skittles:</span>
                <span id="shopSkittles" style="color: #667eea; font-size: 1.3rem;">0</span>
            </div>
            <div class="skin-grid" id="skinGrid"></div>
        </div>

        <!-- Username Modal -->
        <div class="username-modal" id="usernameModal">
            <div class="username-box">
                <h2>üê∂ Welcome to Pug Hub!</h2>
                <p style="margin-bottom: 20px;">Enter your username to begin</p>
                <input type="text" id="usernameInput" placeholder="Your name..." maxlength="20">
                <br>
                <button onclick="setUsername()">Start Playing!</button>
            </div>
        </div>

        <!-- Minigame Modal -->
        <div class="minigame-modal" id="minigameModal">
            <div class="minigame-container">
                <button class="close-minigame" onclick="closeMinigame()">√ó</button>
                <h2 id="minigameTitle">Minigame</h2>
                <canvas id="minigameCanvas" width="800" height="600"></canvas>
                <div class="minigame-info" id="minigameInfo"></div>
            </div>
        </div>
    </div>

    <button class="back-button" onclick="window.location.href='../index.html'" style="position: fixed; bottom: 20px; right: 20px; z-index: 100;">üè† Back to Home</button>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, onChildRemoved, onValue, set, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAPHVHk397y7MpeEZFPuskOqp-IEdiRJ5k",
            authDomain: "pug-31646.firebaseapp.com",
            databaseURL: "https://pug-31646-default-rtdb.firebaseio.com",
            projectId: "pug-31646",
            storageBucket: "pug-31646.firebasestorage.app",
            messagingSenderId: "278556306232",
            appId: "1:278556306232:web:7a82def7c10a1c22f2afcd",
            measurementId: "G-2TBFS939SL"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const playersRef = ref(database, 'pughub/players');
        const chatRef = ref(database, 'pughub/chat');

        // Canvas Setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 1400;
        canvas.height = 700;

        // Game State
        let myPlayer = null;
        let players = {};
        let keys = {};
        let cameraX = 0;
        let skittles = parseInt(localStorage.getItem('pugHubSkittles')) || 0;
        let ownedSkins = JSON.parse(localStorage.getItem('pugHubSkins')) || ['default'];
        let equippedSkin = localStorage.getItem('pugHubEquippedSkin') || 'default';
        let currentMinigame = null;

        // Physics
        const GRAVITY = 0.6;
        const JUMP_STRENGTH = 12;
        const MOVE_SPEED = 5;
        const WORLD_WIDTH = 4000;

        // Skins Database
        const skins = {
            default: {
                name: 'Classic Pug',
                url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExaHJ0NHBkZ3Z2cmF1Mnk1NzF1Y204dWNxMWc0YzZjczQ5eWl2NDNyZiZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/YCXA0BA0dvn3jnmVfP/giphy.gif',
                price: 0,
                owned: true
            },
            party: {
                name: 'Party Pug',
                url: 'https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif',
                price: 100
            },
            rainbow: {
                name: 'Rainbow Pug',
                url: 'https://media.giphy.com/media/3o7TKHKzg46RcRuJPO/giphy.gif',
                price: 250
            },
            dancing: {
                name: 'Dancing Pug',
                url: 'https://media.giphy.com/media/l0HlNQ03J5JxX6lva/giphy.gif',
                price: 500
            },
            wizard: {
                name: 'Wizard Pug',
                url: 'https://media.giphy.com/media/xT9IgN8YKRhByRBzMI/giphy.gif',
                price: 1000
            },
            golden: {
                name: 'Golden Pug',
                url: 'https://media.giphy.com/media/26ufq9mryvc5HI27m/giphy.gif',
                price: 2000
            }
        };

        // Load skin images
        const skinImages = {};
        Object.keys(skins).forEach(key => {
            const img = new Image();
            img.src = skins[key].url;
            img.crossOrigin = "anonymous";
            skinImages[key] = img;
        });

        // World Objects
        const platforms = [
            { x: 0, y: 600, width: WORLD_WIDTH, height: 100 }, // Ground
        ];

        const buildings = [
            { x: 800, y: 400, width: 180, height: 200, color: '#FF6B6B', name: 'üéØ Race Track', type: 'race' },
            { x: 1600, y: 380, width: 200, height: 220, color: '#4ECDC4', name: '‚öΩ Soccer Field', type: 'soccer' },
            { x: 2600, y: 360, width: 220, height: 240, color: '#FFD93D', name: 'üé® Art Studio', type: 'art' },
            { x: 3400, y: 340, width: 240, height: 260, color: '#F093FB', name: 'üé™ Carnival', type: 'carnival' },
            { x: 200, y: 480, width: 160, height: 120, color: '#FFD700', name: 'üõçÔ∏è SHOP', type: 'shop' },
        ];

        const decorations = [
            { x: 100, y: 595, emoji: 'üå≥', size: 60 },
            { x: 500, y: 595, emoji: 'üå≤', size: 50 },
            { x: 900, y: 595, emoji: 'üå≥', size: 55 },
            { x: 1400, y: 595, emoji: 'üå≤', size: 60 },
            { x: 2200, y: 595, emoji: 'üå≥', size: 58 },
            { x: 2800, y: 595, emoji: 'üå≤', size: 52 },
            { x: 3200, y: 595, emoji: 'üå≥', size: 62 },
        ];

        // Clouds
        const clouds = [];
        for (let i = 0; i < 15; i++) {
            clouds.push({
                x: Math.random() * WORLD_WIDTH,
                y: Math.random() * 200 + 50,
                width: Math.random() * 100 + 80,
                speed: Math.random() * 0.3 + 0.1
            });
        }

        // Player Class
        class Player {
            constructor(id, username, x, y, skin = 'default') {
                this.id = id;
                this.username = username;
                this.x = x;
                this.y = y;
                this.width = 50;
                this.height = 50;
                this.velocityY = 0;
                this.velocityX = 0;
                this.isGrounded = false;
                this.skin = skin;
                this.facingRight = true;
            }

            update() {
                // Apply gravity
                this.velocityY += GRAVITY;

                // Apply movement
                this.x += this.velocityX;
                this.y += this.velocityY;

                // Keep in world bounds
                if (this.x < 0) this.x = 0;
                if (this.x > WORLD_WIDTH - this.width) this.x = WORLD_WIDTH - this.width;

                // Platform collision
                this.isGrounded = false;
                for (let platform of platforms) {
                    if (this.velocityY >= 0 &&
                        this.x < platform.x + platform.width &&
                        this.x + this.width > platform.x &&
                        this.y + this.height <= platform.y &&
                        this.y + this.height + this.velocityY >= platform.y) {

                        this.y = platform.y - this.height;
                        this.velocityY = 0;
                        this.isGrounded = true;
                    }
                }

                // Friction
                this.velocityX *= 0.8;
            }

            jump() {
                if (this.isGrounded) {
                    this.velocityY = -JUMP_STRENGTH;
                    this.isGrounded = false;
                }
            }

            moveLeft() {
                this.velocityX = -MOVE_SPEED;
                this.facingRight = false;
            }

            moveRight() {
                this.velocityX = MOVE_SPEED;
                this.facingRight = true;
            }

            draw(offsetX) {
                const screenX = this.x - offsetX;

                // Draw player with skin
                ctx.save();
                if (!this.facingRight) {
                    ctx.translate(screenX + this.width, this.y);
                    ctx.scale(-1, 1);
                    ctx.translate(-screenX - this.width, -this.y);
                }

                if (skinImages[this.skin] && skinImages[this.skin].complete) {
                    ctx.drawImage(skinImages[this.skin], screenX, this.y, this.width, this.height);
                } else {
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(screenX, this.y, this.width, this.height);
                    ctx.font = '30px Arial';
                    ctx.fillText('üê∂', screenX + 10, this.y + 35);
                }

                ctx.restore();

                // Draw username
                ctx.fillStyle = 'black';
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.strokeText(this.username, screenX + this.width/2, this.y - 8);
                ctx.fillText(this.username, screenX + this.width/2, this.y - 8);
            }
        }

        // Draw World
        function drawWorld(offsetX) {
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#E0F6FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Sun
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(1200 - offsetX * 0.1, 100, 50, 0, Math.PI * 2);
            ctx.fill();

            // Clouds
            clouds.forEach(cloud => {
                cloud.x += cloud.speed;
                if (cloud.x > WORLD_WIDTH + 200) cloud.x = -200;

                const cloudX = cloud.x - offsetX * 0.5;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.beginPath();
                ctx.ellipse(cloudX, cloud.y, cloud.width/2, cloud.width/3, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(cloudX + 30, cloud.y - 10, cloud.width/2.5, cloud.width/3.5, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(cloudX - 30, cloud.y - 5, cloud.width/3, cloud.width/4, 0, 0, Math.PI * 2);
                ctx.fill();
            });

            // Mountains (background)
            ctx.fillStyle = '#8B7355';
            ctx.beginPath();
            ctx.moveTo(-offsetX * 0.3, canvas.height);
            ctx.lineTo(200 - offsetX * 0.3, 300);
            ctx.lineTo(400 - offsetX * 0.3, canvas.height);
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(300 - offsetX * 0.3, canvas.height);
            ctx.lineTo(600 - offsetX * 0.3, 250);
            ctx.lineTo(900 - offsetX * 0.3, canvas.height);
            ctx.fill();

            // Buildings
            buildings.forEach(building => {
                const screenX = building.x - offsetX;

                // Building body
                const buildingGradient = ctx.createLinearGradient(screenX, building.y, screenX + building.width, building.y + building.height);
                buildingGradient.addColorStop(0, building.color);
                buildingGradient.addColorStop(1, adjustBrightness(building.color, -20));
                ctx.fillStyle = buildingGradient;
                ctx.fillRect(screenX, building.y, building.width, building.height);

                // Building outline
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 3;
                ctx.strokeRect(screenX, building.y, building.width, building.height);

                // Roof
                ctx.fillStyle = adjustBrightness(building.color, -40);
                ctx.beginPath();
                ctx.moveTo(screenX - 10, building.y);
                ctx.lineTo(screenX + building.width / 2, building.y - 30);
                ctx.lineTo(screenX + building.width + 10, building.y);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                // Windows
                const windowRows = 3;
                const windowCols = 3;
                const windowWidth = 25;
                const windowHeight = 30;
                const windowSpacingX = (building.width - windowCols * windowWidth) / (windowCols + 1);
                const windowSpacingY = (building.height - 50 - windowRows * windowHeight) / (windowRows + 1);

                for (let row = 0; row < windowRows; row++) {
                    for (let col = 0; col < windowCols; col++) {
                        const wx = screenX + windowSpacingX + col * (windowWidth + windowSpacingX);
                        const wy = building.y + 40 + windowSpacingY + row * (windowHeight + windowSpacingY);

                        ctx.fillStyle = '#87CEEB';
                        ctx.fillRect(wx, wy, windowWidth, windowHeight);
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(wx, wy, windowWidth, windowHeight);
                    }
                }

                // Door
                const doorWidth = 50;
                const doorHeight = 70;
                const doorX = screenX + building.width / 2 - doorWidth / 2;
                const doorY = building.y + building.height - doorHeight;
                ctx.fillStyle = '#654321';
                ctx.fillRect(doorX, doorY, doorWidth, doorHeight);
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.strokeRect(doorX, doorY, doorWidth, doorHeight);

                // Door handle
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(doorX + doorWidth - 10, doorY + doorHeight / 2, 4, 0, Math.PI * 2);
                ctx.fill();

                // Building name
                ctx.fillStyle = 'white';
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 3;
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.strokeText(building.name, screenX + building.width / 2, building.y + 25);
                ctx.fillText(building.name, screenX + building.width / 2, building.y + 25);
            });

            // Platforms
            platforms.forEach(platform => {
                const screenX = platform.x - offsetX;

                if (platform.y >= 600) {
                    // Ground - grass
                    const grassGradient = ctx.createLinearGradient(0, platform.y, 0, platform.y + platform.height);
                    grassGradient.addColorStop(0, '#7CFC00');
                    grassGradient.addColorStop(0.3, '#32CD32');
                    grassGradient.addColorStop(1, '#228B22');
                    ctx.fillStyle = grassGradient;
                } else {
                    // Floating platforms - brick
                    const brickGradient = ctx.createLinearGradient(screenX, platform.y, screenX, platform.y + platform.height);
                    brickGradient.addColorStop(0, '#D2691E');
                    brickGradient.addColorStop(1, '#8B4513');
                    ctx.fillStyle = brickGradient;
                }

                ctx.fillRect(screenX, platform.y, platform.width, platform.height);
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(screenX, platform.y, platform.width, platform.height);

                // Grass texture on top of ground
                if (platform.y >= 600) {
                    for (let i = 0; i < platform.width; i += 15) {
                        ctx.fillStyle = '#228B22';
                        ctx.fillRect(screenX + i, platform.y - 5, 2, 5);
                        ctx.fillRect(screenX + i + 5, platform.y - 8, 2, 8);
                        ctx.fillRect(screenX + i + 10, platform.y - 6, 2, 6);
                    }
                }
            });

            // Decorations (trees)
            decorations.forEach(dec => {
                const screenX = dec.x - offsetX;
                ctx.font = `${dec.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(dec.emoji, screenX, dec.y);
            });
        }

        function adjustBrightness(color, amount) {
            const hex = color.replace('#', '');
            const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount));
            const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount));
            const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount));
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        // Check building proximity
        function checkBuildingProximity() {
            if (!myPlayer) return null;

            for (let building of buildings) {
                const doorX = building.x + building.width / 2;
                const doorY = building.y + building.height;

                if (Math.abs(myPlayer.x + myPlayer.width / 2 - doorX) < 80 &&
                    Math.abs(myPlayer.y + myPlayer.height - doorY) < 100) {
                    return building;
                }
            }
            return null;
        }

        // Initialize player
        function setUsername() {
            const username = document.getElementById('usernameInput').value.trim();
            if (username.length < 1) {
                alert('Please enter a valid username!');
                return;
            }

            const playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            myPlayer = new Player(playerId, username, 100, 550, equippedSkin);

            document.getElementById('usernameModal').style.display = 'none';
            document.getElementById('playerName').textContent = username;

            const myPlayerRef = ref(database, `pughub/players/${playerId}`);

            function updateFirebase() {
                set(myPlayerRef, {
                    username: username,
                    x: myPlayer.x,
                    y: myPlayer.y,
                    skin: myPlayer.skin,
                    facingRight: myPlayer.facingRight
                });
            }

            updateFirebase();
            setInterval(updateFirebase, 100);

            onDisconnect(myPlayerRef).remove();

            gameLoop();
        }

        // Listen for other players
        onChildAdded(playersRef, (snapshot) => {
            const data = snapshot.val();
            const id = snapshot.key;

            if (!myPlayer || id !== myPlayer.id) {
                players[id] = new Player(id, data.username, data.x, data.y, data.skin || 'default');
                players[id].facingRight = data.facingRight !== undefined ? data.facingRight : true;
            }
            updateOnlineCount();
        });

        onValue(playersRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                Object.keys(data).forEach(id => {
                    if (myPlayer && id !== myPlayer.id && players[id]) {
                        players[id].x = data[id].x;
                        players[id].y = data[id].y;
                        players[id].skin = data[id].skin || 'default';
                        players[id].facingRight = data[id].facingRight !== undefined ? data[id].facingRight : true;
                    }
                });
            }
        });

        onChildRemoved(playersRef, (snapshot) => {
            const id = snapshot.key;
            delete players[id];
            updateOnlineCount();
        });

        function updateOnlineCount() {
            const count = Object.keys(players).length + (myPlayer ? 1 : 0);
            document.getElementById('onlineCount').textContent = count;
            document.getElementById('chatOnlineCount').textContent = count + ' online';
        }

        // Chat System
        onChildAdded(chatRef, (snapshot) => {
            const msg = snapshot.val();
            displayChatMessage(msg);
        });

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (message.length > 0 && myPlayer) {
                push(chatRef, {
                    username: myPlayer.username,
                    message: message,
                    timestamp: Date.now()
                });
                input.value = '';
            }
        }

        function displayChatMessage(msg) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-message';
            messageEl.innerHTML = `<span class="username">${msg.username}:</span> ${msg.message}`;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            while (messagesDiv.children.length > 50) {
                messagesDiv.removeChild(messagesDiv.firstChild);
            }
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Keyboard controls
        window.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;

            if (myPlayer) {
                if ((e.key === 'w' || e.key === ' ' || e.key === 'ArrowUp') && myPlayer.isGrounded) {
                    myPlayer.jump();
                }

                if (e.key === 'e' || e.key === 'E') {
                    const nearBuilding = checkBuildingProximity();
                    if (nearBuilding) {
                        if (nearBuilding.type === 'shop') {
                            openShop();
                        } else {
                            openMinigame(nearBuilding.type, nearBuilding.name);
                        }
                    }
                }
            }

            if(['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                e.preventDefault();
            }
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        // Update skittles display
        function updateSkittlesDisplay() {
            document.getElementById('skittlesCount').textContent = skittles;
            document.getElementById('shopSkittles').textContent = skittles;
            localStorage.setItem('pugHubSkittles', skittles);
        }

        setInterval(() => {
            if (myPlayer) {
                skittles += 1;
                updateSkittlesDisplay();
            }
        }, 5000);

        // Skin Shop
        function openShop() {
            document.getElementById('skinShop').classList.add('active');
            renderShop();
        }

        function closeShop() {
            document.getElementById('skinShop').classList.remove('active');
        }

        function renderShop() {
            const grid = document.getElementById('skinGrid');
            grid.innerHTML = '';

            Object.keys(skins).forEach(key => {
                const skin = skins[key];
                const owned = ownedSkins.includes(key);
                const equipped = equippedSkin === key;

                const item = document.createElement('div');
                item.className = 'skin-item';
                if (owned) item.classList.add('owned');
                if (equipped) item.classList.add('equipped');

                item.innerHTML = `
                    <img src="${skin.url}" class="skin-preview">
                    <div class="skin-name">${skin.name}</div>
                    <div class="skin-price">${owned ? (equipped ? '‚úì EQUIPPED' : 'OWNED') : skin.price + ' üí∞'}</div>
                `;

                item.onclick = () => {
                    if (owned && !equipped) {
                        equipSkin(key);
                    } else if (!owned && skittles >= skin.price) {
                        buySkin(key, skin.price);
                    } else if (!owned) {
                        alert(`Not enough skittles! You need ${skin.price - skittles} more.`);
                    }
                };

                grid.appendChild(item);
            });

            updateSkittlesDisplay();
        }

        function buySkin(skinKey, price) {
            if (skittles >= price) {
                skittles -= price;
                ownedSkins.push(skinKey);
                localStorage.setItem('pugHubSkins', JSON.stringify(ownedSkins));
                updateSkittlesDisplay();
                renderShop();
                alert(`üéâ You bought ${skins[skinKey].name}!`);
            }
        }

        function equipSkin(skinKey) {
            equippedSkin = skinKey;
            localStorage.setItem('pugHubEquippedSkin', skinKey);
            if (myPlayer) {
                myPlayer.skin = skinKey;
            }
            renderShop();
        }

        window.openShop = openShop;
        window.closeShop = closeShop;
        window.setUsername = setUsername;
        window.sendChatMessage = sendChatMessage;

        // Minigames
        function openMinigame(type, name) {
            currentMinigame = type;
            document.getElementById('minigameModal').classList.add('active');
            document.getElementById('minigameTitle').textContent = name;

            switch(type) {
                case 'race':
                    startRaceGame();
                    break;
                case 'soccer':
                    startSoccerGame();
                    break;
                case 'art':
                    startArtGame();
                    break;
                case 'carnival':
                    startCarnivalGame();
                    break;
            }
        }

        function closeMinigame() {
            currentMinigame = null;
            document.getElementById('minigameModal').classList.remove('active');

            if (window.minigameInterval) {
                clearInterval(window.minigameInterval);
            }
            if (window.minigameAnimationFrame) {
                cancelAnimationFrame(window.minigameAnimationFrame);
            }
        }

        window.closeMinigame = closeMinigame;

        // Race Game
        function startRaceGame() {
            const mgCanvas = document.getElementById('minigameCanvas');
            const mgCtx = mgCanvas.getContext('2d');
            const info = document.getElementById('minigameInfo');

            let raceX = 0;
            let raceSpeed = 0;
            let obstacles = [];
            let score = 0;
            let gameOver = false;

            for (let i = 0; i < 10; i++) {
                obstacles.push({
                    x: 1000 + i * 400,
                    y: 500,
                    width: 40,
                    height: 40
                });
            }

            const raceKeys = {};
            const keyHandler = (e) => {
                if (e.key === 'ArrowRight' || e.key === 'd') raceSpeed = 8;
                if (e.key === 'ArrowLeft' || e.key === 'a') raceSpeed = -3;
            };
            const keyUpHandler = (e) => {
                if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'ArrowLeft' || e.key === 'a') {
                    raceSpeed = 0;
                }
            };

            window.addEventListener('keydown', keyHandler);
            window.addEventListener('keyup', keyUpHandler);

            function raceLoop() {
                if (gameOver) return;

                mgCtx.fillStyle = '#87CEEB';
                mgCtx.fillRect(0, 0, mgCanvas.width, mgCanvas.height);

                // Track
                mgCtx.fillStyle = '#444';
                mgCtx.fillRect(0, 500, mgCanvas.width, 100);

                // Track lines
                mgCtx.strokeStyle = '#FFD700';
                mgCtx.lineWidth = 5;
                mgCtx.setLineDash([20, 15]);
                mgCtx.beginPath();
                mgCtx.moveTo(0, 550);
                mgCtx.lineTo(mgCanvas.width, 550);
                mgCtx.stroke();
                mgCtx.setLineDash([]);

                raceX += raceSpeed;
                score = Math.floor(raceX / 10);

                // Draw player
                mgCtx.fillStyle = '#FF6B6B';
                mgCtx.fillRect(100, 520, 50, 50);
                mgCtx.font = '30px Arial';
                mgCtx.fillText('üê∂', 105, 555);

                // Draw obstacles
                obstacles.forEach(obs => {
                    obs.x -= raceSpeed;

                    const screenX = obs.x - raceX + 100;
                    mgCtx.fillStyle = '#8B4513';
                    mgCtx.fillRect(screenX, obs.y, obs.width, obs.height);
                    mgCtx.font = '30px Arial';
                    mgCtx.fillText('ü™®', screenX + 5, obs.y + 30);

                    // Collision
                    if (screenX < 150 && screenX + obs.width > 100 &&
                        520 < obs.y + obs.height && 570 > obs.y) {
                        gameOver = true;
                        skittles += Math.floor(score / 10);
                        updateSkittlesDisplay();
                        window.removeEventListener('keydown', keyHandler);
                        window.removeEventListener('keyup', keyUpHandler);
                        alert(`Game Over! You earned ${Math.floor(score / 10)} skittles! Final score: ${score}`);
                        closeMinigame();
                    }
                });

                // Score
                mgCtx.fillStyle = 'white';
                mgCtx.font = 'bold 24px Arial';
                mgCtx.fillText(`Distance: ${score}m`, 20, 40);
                mgCtx.fillText(`Press ‚Üí to accelerate`, 20, 70);

                info.innerHTML = `<strong>üéØ Race Track:</strong> Press ‚Üí to speed up! Avoid obstacles. Score: ${score}m`;

                window.minigameAnimationFrame = requestAnimationFrame(raceLoop);
            }

            raceLoop();
        }

        // Soccer Game
        function startSoccerGame() {
            const mgCanvas = document.getElementById('minigameCanvas');
            const mgCtx = mgCanvas.getContext('2d');
            const info = document.getElementById('minigameInfo');

            let ballX = 400;
            let ballY = 500;
            let ballVx = 0;
            let ballVy = 0;
            let playerX = 200;
            let score = 0;

            const soccerKeys = {};
            const keyHandler = (e) => { soccerKeys[e.key] = true; };
            const keyUpHandler = (e) => { soccerKeys[e.key] = false; };

            window.addEventListener('keydown', keyHandler);
            window.addEventListener('keyup', keyUpHandler);

            function soccerLoop() {
                mgCtx.fillStyle = '#228B22';
                mgCtx.fillRect(0, 0, mgCanvas.width, mgCanvas.height);

                // Field lines
                mgCtx.strokeStyle = 'white';
                mgCtx.lineWidth = 3;
                mgCtx.strokeRect(50, 50, 700, 500);
                mgCtx.beginPath();
                mgCtx.arc(400, 300, 80, 0, Math.PI * 2);
                mgCtx.stroke();

                // Goals
                mgCtx.strokeStyle = '#FF6B6B';
                mgCtx.lineWidth = 5;
                mgCtx.strokeRect(20, 220, 30, 160);
                mgCtx.strokeRect(750, 220, 30, 160);

                // Player movement
                if (soccerKeys['a'] || soccerKeys['ArrowLeft']) playerX -= 5;
                if (soccerKeys['d'] || soccerKeys['ArrowRight']) playerX += 5;

                playerX = Math.max(50, Math.min(700, playerX));

                // Draw player
                mgCtx.fillStyle = '#4ECDC4';
                mgCtx.fillRect(playerX, 500, 40, 40);
                mgCtx.font = '30px Arial';
                mgCtx.fillText('üê∂', playerX + 5, 535);

                // Ball physics
                ballVy += 0.5; // gravity
                ballX += ballVx;
                ballY += ballVy;

                // Ball ground collision
                if (ballY > 520) {
                    ballY = 520;
                    ballVy *= -0.7;
                    ballVx *= 0.9;
                }

                // Ball wall collision
                if (ballX < 60 || ballX > 730) {
                    ballVx *= -1;
                    if (ballY > 220 && ballY < 380) {
                        // GOAL!
                        score += 10;
                        skittles += 5;
                        updateSkittlesDisplay();
                        ballX = 400;
                        ballY = 300;
                        ballVx = 0;
                        ballVy = 0;
                        alert('‚öΩ GOAL! +5 skittles!');
                    }
                }

                // Player kicks ball
                if (Math.abs(ballX - playerX - 20) < 40 && Math.abs(ballY - 520) < 40) {
                    ballVy = -15;
                    ballVx = (ballX - playerX - 20) / 3;
                }

                // Draw ball
                mgCtx.fillStyle = 'white';
                mgCtx.beginPath();
                mgCtx.arc(ballX, ballY, 15, 0, Math.PI * 2);
                mgCtx.fill();
                mgCtx.strokeStyle = 'black';
                mgCtx.lineWidth = 2;
                mgCtx.stroke();
                mgCtx.font = '20px Arial';
                mgCtx.fillText('‚öΩ', ballX - 10, ballY + 7);

                // Score
                mgCtx.fillStyle = 'white';
                mgCtx.font = 'bold 24px Arial';
                mgCtx.strokeStyle = 'black';
                mgCtx.lineWidth = 3;
                mgCtx.strokeText(`Score: ${score}`, 340, 40);
                mgCtx.fillText(`Score: ${score}`, 340, 40);

                info.innerHTML = `<strong>‚öΩ Soccer:</strong> Use A/D to move. Kick the ball into the goals! Score: ${score}`;

                window.minigameAnimationFrame = requestAnimationFrame(soccerLoop);
            }

            soccerLoop();
        }

        // Art Game
        function startArtGame() {
            const mgCanvas = document.getElementById('minigameCanvas');
            const mgCtx = mgCanvas.getContext('2d');
            const info = document.getElementById('minigameInfo');

            mgCtx.fillStyle = 'white';
            mgCtx.fillRect(0, 0, mgCanvas.width, mgCanvas.height);

            let drawing = false;
            let currentColor = '#000000';
            let brushSize = 5;

            const colors = ['#000000', '#FF6B6B', '#4ECDC4', '#45B7D1', '#F093FB', '#FFD93D', '#4D96FF', '#FFFFFF'];

            // Draw palette
            function drawPalette() {
                colors.forEach((color, i) => {
                    mgCtx.fillStyle = color;
                    mgCtx.fillRect(10 + i * 50, 10, 40, 40);
                    mgCtx.strokeStyle = currentColor === color ? '#FFD700' : '#333';
                    mgCtx.lineWidth = 3;
                    mgCtx.strokeRect(10 + i * 50, 10, 40, 40);
                });

                // Brush size controls
                mgCtx.fillStyle = 'white';
                mgCtx.fillRect(600, 10, 180, 40);
                mgCtx.strokeStyle = '#333';
                mgCtx.lineWidth = 2;
                mgCtx.strokeRect(600, 10, 180, 40);
                mgCtx.fillStyle = '#333';
                mgCtx.font = 'bold 16px Arial';
                mgCtx.fillText(`Brush: ${brushSize}px`, 610, 35);
            }

            drawPalette();

            const mouseDownHandler = (e) => {
                const rect = mgCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Check color palette
                colors.forEach((color, i) => {
                    if (x >= 10 + i * 50 && x <= 50 + i * 50 && y >= 10 && y <= 50) {
                        currentColor = color;
                        drawPalette();
                    }
                });

                if (y > 60) {
                    drawing = true;
                }
            };

            const mouseMoveHandler = (e) => {
                if (drawing) {
                    const rect = mgCanvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    mgCtx.fillStyle = currentColor;
                    mgCtx.beginPath();
                    mgCtx.arc(x, y, brushSize, 0, Math.PI * 2);
                    mgCtx.fill();
                }
            };

            const mouseUpHandler = () => {
                drawing = false;
            };

            const wheelHandler = (e) => {
                e.preventDefault();
                brushSize += e.deltaY > 0 ? -1 : 1;
                brushSize = Math.max(1, Math.min(20, brushSize));
                mgCtx.clearRect(600, 10, 180, 40);
                drawPalette();
            };

            mgCanvas.addEventListener('mousedown', mouseDownHandler);
            mgCanvas.addEventListener('mousemove', mouseMoveHandler);
            mgCanvas.addEventListener('mouseup', mouseUpHandler);
            mgCanvas.addEventListener('wheel', wheelHandler);

            info.innerHTML = `<strong>üé® Art Studio:</strong> Click colors to change brush. Draw on canvas! Scroll to change brush size. <button onclick="document.getElementById('minigameCanvas').getContext('2d').fillStyle='white'; document.getElementById('minigameCanvas').getContext('2d').fillRect(0, 0, 800, 600); window.dispatchEvent(new Event('redrawArtPalette'));" style="margin-left: 10px; padding: 5px 10px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer;">Clear Canvas</button>`;

            window.addEventListener('redrawArtPalette', drawPalette);
        }

        // Carnival Game (Whack-a-Mole)
        function startCarnivalGame() {
            const mgCanvas = document.getElementById('minigameCanvas');
            const mgCtx = mgCanvas.getContext('2d');
            const info = document.getElementById('minigameInfo');

            let score = 0;
            let timeLeft = 30;
            let moles = [];

            for (let i = 0; i < 9; i++) {
                moles.push({
                    x: 100 + (i % 3) * 250,
                    y: 150 + Math.floor(i / 3) * 200,
                    visible: false,
                    timer: 0
                });
            }

            window.minigameInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(window.minigameInterval);
                    skittles += score;
                    updateSkittlesDisplay();
                    alert(`üé™ Time's up! You scored ${score} points and earned ${score} skittles!`);
                    closeMinigame();
                }
            }, 1000);

            const clickHandler = (e) => {
                const rect = mgCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                moles.forEach(mole => {
                    if (mole.visible &&
                        x >= mole.x - 40 && x <= mole.x + 40 &&
                        y >= mole.y - 40 && y <= mole.y + 40) {
                        mole.visible = false;
                        score += 10;
                    }
                });
            };

            mgCanvas.addEventListener('click', clickHandler);

            function carnivalLoop() {
                mgCtx.fillStyle = '#F093FB';
                mgCtx.fillRect(0, 0, mgCanvas.width, mgCanvas.height);

                // Random mole appearance
                moles.forEach(mole => {
                    if (!mole.visible && Math.random() < 0.02) {
                        mole.visible = true;
                        mole.timer = 60;
                    }

                    if (mole.visible) {
                        mole.timer--;
                        if (mole.timer <= 0) {
                            mole.visible = false;
                        }
                    }

                    // Draw hole
                    mgCtx.fillStyle = '#654321';
                    mgCtx.beginPath();
                    mgCtx.ellipse(mole.x, mole.y + 20, 45, 25, 0, 0, Math.PI * 2);
                    mgCtx.fill();

                    // Draw mole if visible
                    if (mole.visible) {
                        mgCtx.font = '60px Arial';
                        mgCtx.fillText('üê∂', mole.x - 30, mole.y + 10);
                    }
                });

                // Score and timer
                mgCtx.fillStyle = 'white';
                mgCtx.strokeStyle = 'black';
                mgCtx.lineWidth = 3;
                mgCtx.font = 'bold 28px Arial';
                mgCtx.strokeText(`Score: ${score}`, 20, 40);
                mgCtx.fillText(`Score: ${score}`, 20, 40);
                mgCtx.strokeText(`Time: ${timeLeft}s`, 620, 40);
                mgCtx.fillText(`Time: ${timeLeft}s`, 620, 40);

                info.innerHTML = `<strong>üé™ Carnival:</strong> Click the pugs! Score: ${score} | Time: ${timeLeft}s`;

                window.minigameAnimationFrame = requestAnimationFrame(carnivalLoop);
            }

            carnivalLoop();
        }

        // Game Loop
        function gameLoop() {
            if (!myPlayer) return;

            // Handle movement
            if (keys['a'] || keys['arrowleft']) {
                myPlayer.moveLeft();
            }
            if (keys['d'] || keys['arrowright']) {
                myPlayer.moveRight();
            }

            // Update player
            myPlayer.update();

            // Update camera (follow player)
            cameraX = myPlayer.x - canvas.width / 2 + myPlayer.width / 2;
            cameraX = Math.max(0, Math.min(WORLD_WIDTH - canvas.width, cameraX));

            // Draw everything
            drawWorld(cameraX);

            // Check for building proximity
            const nearBuilding = checkBuildingProximity();
            if (nearBuilding) {
                const doorX = nearBuilding.x - cameraX + nearBuilding.width / 2;
                const doorY = nearBuilding.y + nearBuilding.height - 20;

                ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                const textWidth = 180;
                ctx.fillRect(doorX - textWidth/2, doorY - 80, textWidth, 35);
                ctx.strokeRect(doorX - textWidth/2, doorY - 80, textWidth, 35);
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Press E to Enter!', doorX, doorY - 58);
            }

            // Draw my player
            myPlayer.draw(cameraX);

            // Draw other players
            Object.values(players).forEach(player => {
                player.draw(cameraX);
            });

            requestAnimationFrame(gameLoop);
        }

        // Initialize
        updateSkittlesDisplay();
        document.getElementById('usernameInput').focus();
    </script>
</body>
</html>
